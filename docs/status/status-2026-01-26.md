# Status Report - January 26, 2026

## Summary

Fixed MCP SSE server error and addressed performance issues with bulk item operations. Also completed open source launch preparation tasks including Code of Conduct, issue templates, and PR template.

## Issues Investigated

### MCP SSE TypeError

**Symptom:** Intermittent errors in MCP SSE server logs:
```
ERROR: Exception in ASGI application
TypeError: 'NoneType' object is not callable
```

**Root Cause:** The `handle_sse` function in `mcp_sse.py` did not return a response when the SSE connection closed normally. Starlette requires route handlers to return a `Response` object.

**Fix:** Added `return Response(status_code=200)` after the SSE connection context manager exits.

### MCP Bulk Operations Performance

**Symptom:** Moving 45 items from one bin to another took over 20 minutes and failed after 33 items.

**Investigation:** Added timing instrumentation to MCP tool calls. Results showed:
- Individual `move_item` operations completed in ~0.01-0.05s (database is fast)
- MCP protocol round-trip overhead: 2-3 seconds per tool call
- Total overhead for 45 items: 45 x 2.5s = ~112 seconds just in protocol overhead

**Root Cause:** No bulk move operation existed. Each item required a separate MCP tool call with significant protocol overhead (SSE transport, JSON serialization, Claude processing time between calls).

**Fix:** Added `move_items_bulk` tool that accepts an array of moves and processes them in a single operation.

## Work Completed

### Bug Fixes

1. **MCP SSE NoneType Error** - `mcp_sse.py`
   - Added `Response` import from starlette
   - Added return statement when SSE connection closes normally

### Performance Improvements

2. **MCP Tool Call Timing** - `server.py`
   - Added timing instrumentation to `call_tool()` function
   - Logs tool name, start time, and duration for every call
   - Example output: `INFO:protea:Tool move_item completed in 0.045s`

3. **Bulk Move Operation** - `tools/items.py`, `server.py`
   - Added `move_items_bulk(moves, notes)` function
   - Accepts array of `{item_id, to_bin_id}` objects
   - Validates all bins and items in batch queries (2 queries total)
   - Executes all moves in a single database transaction
   - Returns detailed results with success/failure counts

### Performance Comparison

| Scenario | Individual `move_item` | `move_items_bulk` |
|----------|------------------------|-------------------|
| 45 items | 45 MCP round-trips (~112s overhead) | 1 MCP round-trip (~2.5s overhead) |
| DB connections | 180 (4 per item) | ~3 total |
| Failure handling | Stops on first error | Continues, reports all failures |

### Open Source Launch Preparation

4. **CODE_OF_CONDUCT.md** (new file)
   - Concise code of conduct adapted from Contributor Covenant
   - Covers expected behavior, unacceptable behavior, enforcement, reporting

5. **GitHub Issue Templates** (new directory `.github/ISSUE_TEMPLATE/`)
   - `bug_report.md` - structured bug report template
   - `feature_request.md` - feature request template
   - `config.yml` - disables blank issues, links to Discussions for questions

6. **Pull Request Template**
   - `.github/PULL_REQUEST_TEMPLATE.md` - summary, changes, how to test, checklist

## Files Changed

| File | Changes |
|------|---------|
| `src/protea/mcp_sse.py` | Added Response import, return statement for normal close |
| `src/protea/server.py` | Added timing logs, `move_items_bulk` tool definition and handler |
| `src/protea/tools/items.py` | Added `move_items_bulk()` function |
| `tests/test_items.py` | Added 3 tests for bulk move |
| `CODE_OF_CONDUCT.md` | New file - community behavior guidelines |
| `.github/ISSUE_TEMPLATE/bug_report.md` | New file - bug report template |
| `.github/ISSUE_TEMPLATE/feature_request.md` | New file - feature request template |
| `.github/ISSUE_TEMPLATE/config.yml` | New file - issue template configuration |
| `.github/PULL_REQUEST_TEMPLATE.md` | New file - PR template |
| `docs/features/open-source-launch.md` | Marked completed tasks |

## Test Results

```
246 passed, 1 skipped, 6 warnings
```

## Lessons Learned

1. **MCP protocol overhead is significant** - For bulk operations, always prefer single tool calls that accept arrays over multiple individual calls.

2. **Timing instrumentation is valuable** - Adding simple timing logs quickly identified that the bottleneck was protocol overhead, not database performance.

3. **Starlette route handlers must return responses** - Even for SSE endpoints that stream data, a response object must be returned when the connection closes.

4. **Use real identity for open source** - Personal GitHub accounts with real names build more trust than anonymous accounts. Old repos can be archived to clean up the profile while preserving history.

## Next Steps

### Open Source Launch
1. Clean up personal GitHub account (rmaxseiner) - archive/delete old repos
2. Push Protea to GitHub
3. Enable GitHub Discussions
4. Create GitHub Project board for roadmap visibility
5. Write announcement blog post

### Technical
1. Consider adding other bulk operations (`delete_items_bulk` already exists)
2. Monitor MCP performance in production with timing logs
3. Consider bulk operations for other entity types (bins, categories) if needed
